<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <title>JBTV - Kajian Islam & Pengumuman</title>
    <meta property="og:title" content="JBTV - Kajian Islam & Pengumuman" />
    <meta property="og:description" content="Siaran langsung dan info kajian rutin dari JBTV." />
    <meta property="og:image" content="https://i.postimg.cc/L4bXV47w/Thumbnail-Website.png" />
    <meta property="og:url" content="https://jbtv-id.netlify.app" />
    <meta name="twitter:card" content="summary_large_image" />
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
    <style>
        :root { --color-bg-white: #ffffff; --color-bg-grey: #f7f7f7; --color-text: #333; --color-primary: #007bff; --color-dark: #343a40; --color-green: #28a745; --color-red: #dc3545; --color-blue: #17a2b8; --timeline-line-color: #e0e0e0;}
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif; margin: 0; padding: 0; background-color: var(--color-bg-grey); color: var(--color-text); }
        body.reels-active { overflow: hidden; }
        .container { max-width: 900px; margin: 0 auto; padding: 40px 20px; }
        h2 { font-size: 2.2em; text-align: center; margin-bottom: 40px; color: var(--color-dark); }
        h4 { font-size: 1em; text-align: center; margin-top: -40px; color: var(--color-dark); }
        .section-white { background-color: var(--color-bg-white); }
        .section-grey { background-color: #114ed7; }
        .section-grey h2, .section-grey h4, .section-grey p, .section-grey li { color: white; }
        .section-grey h4 { color: #d1d1d1; }
        .live-streaming-wrapper { text-align: center; }
        .video-container { position: relative; width: 100%; padding-bottom: 56.25%; height: 0; overflow: hidden; margin-bottom: 20px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .video-container iframe { position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: 0; }
        .news-ticker { display: flex; align-items: center; background-color: #114ed7; color: white; padding: 5px 10px; border-radius: 4px; margin: 25px auto; overflow: hidden; box-shadow: 0 0px 0px rgba(0,0,0,0.3); }
        .news-ticker:hover .streaming-info { animation-play-state: paused; }
        .ticker-prefix { flex-shrink: 0; display: flex; align-items: center; padding-right: 10px; margin-right: 10px; border-right: 1px solid rgba(255,255,255,0.4); }
        .date-time-section { font-weight: bold; font-size: 0.6em; text-align: center; background-color: var(--color-red); padding: 4px 8px; border-radius: 3px; color: white; }
        .date-time-section span { display: block; }
        #live-time { font-size: 1.1em; }
        .marquee-section { flex-grow: 1; overflow: hidden; }
        .streaming-info { font-size: 0.9em; color: white; display: inline-block; padding-left: 100%; white-space: nowrap; animation: marquee 20s linear; margin: 0; vertical-align: middle; will-change: transform; }
        @keyframes marquee { 0% { transform: translateX(0%); } 100% { transform: translateX(-100%); } }
        .post-actions { display: flex; align-items: center; justify-content: center; gap: 20px; border-top: 1px solid #eee; border-bottom: 1px solid #eee; padding: 10px 0; margin-bottom: 20px; }
        .action-btn { background: none; border: none; cursor: pointer; font-size: 1em; color: #555; display: flex; align-items: center; gap: 8px; }
        .action-btn:hover { color: var(--color-primary); }
        .action-btn i { font-size: 1.2em; }
        #comments-wrapper { display: none; margin-top: 20px; }
        .timeline-container { width: 100%; }
        .timeline-content { display: none; }
        .timeline-content.active { display: block; }
        .timeline { position: relative; list-style: none; padding-left: 40px; margin: 0; }
        .timeline::before { content: ''; position: absolute; left: 10px; top: 0; bottom: 0; width: 3px; background-color: #5d8bf2; border-radius: 3px; }
        .timeline-item { position: relative; margin-bottom: 30px; }
        .timeline-item::after { content: ''; position: absolute; left: -35px; top: 5px; width: 13px; height: 13px; background-color: #114ed7; border: 3px solid #5d8bf2; border-radius: 50%; z-index: 1; }
        .timeline-item-content { background-color: #2a65e0; padding: 20px; border-radius: 8px; border: 1px solid #5d8bf2; }
        .timeline-tag { display: inline-block; padding: 5px 12px; border-radius: 5px; font-size: 0.9em; font-weight: 600; margin-right: 8px; margin-bottom: 10px; }
        .tag-dark { background-color: var(--color-dark); color: white; }
        .tag-red { background-color: var(--color-red); color: white; }
        .tag-green { background-color: var(--color-green); color: white; margin-top: 10px; }
        .tag-blue { background-color: var(--color-blue); color: white; }
        .pengumuman-content { display: flex; gap: 20px; align-items: flex-start; }
        .pengumuman-flyer { width: 120px; height: auto; border-radius: 8px; object-fit: cover; }
        .pengumuman-details { flex: 1; }
        @media (max-width: 600px) { .pengumuman-content { flex-direction: column; } .pengumuman-flyer { width: 100%; max-width: 250px; } }
        .timeline-dropdown-wrapper { display: flex; justify-content: center; margin-bottom: 30px; }
        .custom-dropdown { appearance: none; -webkit-appearance: none; background-color: #ffffff; color: #333; padding: 12px 40px 12px 16px; font-size: 1em; font-weight: 600; border: 2px solid #fff; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.05); background-image: url('data:image/svg+xml;charset=UTF-8,<svg width="16" height="16" fill="gray" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg"><path d="M1.5 5.5l6 6 6-6" stroke="gray" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/></svg>'); background-repeat: no-repeat; background-position: right 12px center; background-size: 16px; cursor: pointer; }
        .wa-float-container { position: fixed; bottom: 20px; right: 20px; display: flex; flex-direction: column; gap: 8px; z-index: 999; align-items: flex-end; }
        .wa-float { display: flex; align-items: center; gap: 8px; padding: 10px 16px; color: #fff; border-radius: 50px; font-weight: bold; text-decoration: none; box-shadow: 0 4px 10px rgba(0,0,0,0.2); font-size: 14px; }
        .wa-float:hover { transform: scale(1.05); }
        .wa-ikhwan { background-color: #25D366; }
        .wa-akhwat { background-color: #128C7E; }
        .wa-label { background-color: #333; color: white; padding: 4px 10px; font-size: 12px; border-radius: 12px; margin-right: 5px; opacity: 0.8; }
        .section-about p { font-size: 0.9em; max-width: 700px; margin: 25px auto; margin-top: -20px; text-align: center; font-style: normal; font-weight: normal; color: white; }
        footer { background-color: var(--color-dark); color: white; text-align: center; font-size: 0.9em; }
        footer .container { padding: 20px; }
        .reels-float-container { position: fixed; bottom: 20px; left: 20px; z-index: 998; }
        #reels-float-button { background-color: #e71d43; color: white; width: 55px; height: 55px; border-radius: 50%; display: none; align-items: center; justify-content: center; font-size: 24px; box-shadow: 0 4px 10px rgba(0,0,0,0.2); border: none; cursor: pointer; }
        #reels-float-button i { margin-left: 2px; }
        .reels-viewer { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: #000; z-index: 10000; display: none; }
        .reels-viewer.active { display: block; }
        .reels-container { width: 100%; height: 100%; overflow-y: scroll; scroll-snap-type: y mandatory; -webkit-overflow-scrolling: touch; }
        .reels-container::-webkit-scrollbar { display: none; }
        .reels-container { -ms-overflow-style: none; scrollbar-width: none; }
        .reel-slide { width: 100%; height: 100vh; display: flex; justify-content: center; align-items: center; scroll-snap-align: start; position: relative; }
        .reel-video-wrapper { position: relative; max-width: 56.25vh; width: 90%; height: 80vh; display: flex; justify-content: center; align-items: center; }
        .reel-thumbnail { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; z-index: 1; transition: opacity 0.4s ease-in-out; border-radius: 12px; }
        .reel-iframe-container { position: relative; width: 100%; height: 100%; border-radius: 12px; overflow: hidden; background-color: #1a1a1a; }
        .reel-iframe-container iframe { width: 100%; height: 100%; border: 0; opacity: 0; transition: opacity 0.4s ease-in-out; z-index: 2; position: relative; }
        .reel-iframe-container iframe.loaded { opacity: 1; }
        .reel-ui-overlay { position: absolute; bottom: 0; left: 0; right: 0; z-index: 3; padding: 20px 15px; color: white; text-shadow: 1px 1px 3px rgba(0,0,0,0.8); background: linear-gradient(to top, rgba(0,0,0,0.7) 0%, rgba(0,0,0,0) 100%); pointer-events: none; border-radius: 0 0 12px 12px; }
        .reel-title { font-size: 1.1em; font-weight: bold; margin-bottom: 5px; }
        .reel-channel { font-size: 0.9em; opacity: 0.9; }
        .unmute-button { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 4; background: rgba(0,0,0,0.6); color: white; border: 2px solid white; width: 60px; height: 60px; border-radius: 50%; font-size: 24px; cursor: pointer; display: none; align-items: center; justify-content: center; opacity: 0; transition: opacity 0.3s; }
        .unmute-button.visible { display: flex; opacity: 1; }
        .reels-close-button { position: absolute; top: 20px; left: 20px; background: rgba(0,0,0,0.5); color: white; border: none; border-radius: 50%; width: 40px; height: 40px; font-size: 20px; cursor: pointer; z-index: 10001; display: flex; align-items: center; justify-content: center; }
    </style>
</head>
<body>
    <section class="section-white">
        <div class="container live-streaming-wrapper">
            <h2></h2>
            <h4></h4>
            <div class="video-container">
                <iframe src="https://www.facebook.com/plugins/video.php?href=https://web.facebook.com/jbtv17/videos/1048093734075136/?app=fbl" frameborder="0" allowfullscreen></iframe>
            </div>
            <div class="news-ticker">
                <div class="ticker-prefix">
                    <div class="date-time-section"><span id="live-time"></span></div>
                </div>
                <div class="marquee-section"><p class="streaming-info"></p></div>
            </div>
            <div class="post-actions">
                <button class="action-btn" id="viewersBtn" title="Sedang menonton"><i class="fa-solid fa-eye"></i><span id="viewersCount">0</span></button>
                <button class="action-btn" id="likeBtn" title="Suka"><i class="fa-solid fa-thumbs-up"></i><span id="likeCount">0</span></button>
                <button class="action-btn" id="commentBtn" title="Komentar"><i class="fa-solid fa-comment"></i><span id="commentCount">0</span></button>
                <button class="action-btn" id="shareBtn" title="Bagikan"><i class="fa-solid fa-share"></i><span id="shareCount">0</span></button>
            </div>
            <div id="comments-wrapper">
                <section class="section-white">
                    <div class="container">
                        <h2 style="font-size: 1.5em; margin-top: -30px;"></h2>
                        <form id="commentForm" style="margin-top: -70px;">
                            <input type="text" id="name" placeholder="Nama Anda" required style="padding: 10px; width: 100%; margin-bottom: 10px; border-radius: 5px; border: 1px solid #ccc;">
                            <textarea id="comment" placeholder="Tulis komentar..." required style="padding: 10px; width: 100%; height: 100px; border-radius: 5px; border: 1px solid #ccc;"></textarea>
                            <button type="submit" style="padding: 10px 20px; background-color: #007bff; color: white; border: none; border-radius: 5px; margin-top: 20px; margin-bottom: 20px;">Kirim Komentar</button>
                        </form>
                        <div id="commentsList"></div>
                    </div>
                </section>
            </div>
        </div>
    </section>

    <section class="section-grey">
        <div class="container">
            <h2><strong>Jadwal Kajian Rutin</strong></h2>
            <h4 id="rentangTanggalKajian">Memuat tanggal...</h4>
            <div class="timeline-container">
                <div class="timeline-nav timeline-dropdown-wrapper">
                    <select id="ustadzDropdown" onchange="openDropdownTab(event)" class="custom-dropdown">
                        <option value="ustad1">TGH. Suharni Abdul Manan, Lc.</option>
                        <option value="ustad2">Ust. Zamakhsyari Dhofir, Lc., M.A.</option>
                        <option value="ustad3">Ust. Ahmad Marwazi Manar, S.H., M.A.</option>
                    </select>
                </div>
                <div id="ustad1" class="timeline-content active"><ul class="timeline" id="jadwal-ustad1"></ul></div>
                <div id="ustad2" class="timeline-content"><ul class="timeline" id="jadwal-ustad2"></ul></div>
                <div id="ustad3" class="timeline-content"><ul class="timeline" id="jadwal-ustad3"></ul></div>
            </div>
        </div>
    </section>

    <section class="section-white">
        <div class="container">
            <h2><strong>Pengumuman Penting</strong></h2>
            <ul class="timeline" id="pengumuman-container"></ul>
        </div>
    </section>

    <section class="section-grey section-about">
        <div class="container">
            <h2><strong>Tentang JBTV</strong></h2>
            <p><strong>JB TV</strong> adalah saluran media dakwah di bawah naungan Pondok Pesantren Jamaluddin, Bagik Nyaka. Tujuan kami adalah menyebarkan ilmu syar'i secara luas dan mudah diakses oleh umat. Kami berkomitmen untuk menghadirkan konten yang bermanfaat, terpercaya, dan sesuai dengan manhaj Ahlus Sunnah wal Jama'ah.</p>
        </div>
    </section>
    
    <div class="wa-float-container">
        <div class="wa-label">Group WA</div>
        <a href="https://chat.whatsapp.com/KIDegAern9GF0Z1wzkxoJ2" target="_blank" class="wa-float wa-ikhwan" title="Gabung Grup Ikhwan"><i class="fab fa-whatsapp"></i> Ikhwan</a>
        <a href="https://chat.whatsapp.com/Kmd1of6VpRi9kWxrnNXUdH" target="_blank" class="wa-float wa-akhwat" title="Gabung Grup Akhawat"><i class="fab fa-whatsapp"></i> Akhwat</a>
    </div>

    <div class="reels-float-container">
        <button id="reels-float-button" title="Tonton Video Kajian Singkat"><i class="fa-solid fa-play"></i></button>
    </div>

    <div id="reelsViewer" class="reels-viewer">
        <button id="reelsCloseButton" class="reels-close-button">&times;</button>
        <div id="reelsContainer" class="reels-container"></div>
    </div>
    
    <footer>
        <div class="container">© 2025 JBTV | By: Muzanni</div>
    </footer>

    <script>
        function openDropdownTab(evt) {
            const selectedValue = evt.target.value;
            const tabcontent = document.getElementsByClassName("timeline-content");
            for (let i = 0; i < tabcontent.length; i++) { tabcontent[i].style.display = "none"; }
            document.getElementById(selectedValue).style.display = "block";
        }

        document.addEventListener("DOMContentLoaded", function () {
            if (document.getElementById("ustadzDropdown")) {
                document.getElementById("ustadzDropdown").value = "ustad1";
                document.getElementById("ustad1").style.display = "block";
            }
            const firebaseConfig = {
                apiKey: "AIzaSyAowVtnXTVstFSc3kSBTm5tXJkEvp31V2Y",
                authDomain: "streamingjbtv.firebaseapp.com",
                databaseURL: "https://streamingjbtv-default-rtdb.asia-southeast1.firebasedatabase.app",
                projectId: "streamingjbtv",
                storageBucket: "streamingjbtv.appspot.com",
                messagingSenderId: "191301318558",
                appId: "1:191301318558:web:f32dada7468d8a4486088f"
            };
            firebase.initializeApp(firebaseConfig);
            const db = firebase.database();

            // --- LOGIKA ASLI ANDA ---
            const liveTimeEl = document.getElementById('live-time');
            if(liveTimeEl){
                function updateDateTime() { const now = new Date(); const padZero = (n) => (n < 10 ? '0' + n : n); liveTimeEl.textContent = `${padZero(now.getHours())}:${padZero(now.getMinutes())}:${padZero(now.getSeconds())} Wita`; }
                updateDateTime(); setInterval(updateDateTime, 1000);
            }
            const streamingInfoEl = document.querySelector('.streaming-info');
            if(streamingInfoEl){
                const messages = ["Selamat datang di JBTV...", "Saksikan siaran langsung...", "Dukung dakwah JBTV..."]; let msgIndex = 0;
                function runMarquee() { streamingInfoEl.innerHTML = messages[msgIndex]; streamingInfoEl.style.animation = 'marquee 20s linear 1'; }
                streamingInfoEl.addEventListener('animationend', () => { msgIndex = (msgIndex + 1) % messages.length; runMarquee(); });
                runMarquee();
            }
            const videoIframe = document.querySelector('.video-container iframe');
            if (videoIframe) {
                const videoId = btoa(videoIframe.src);
                const commentsRef = db.ref(`video_interactions/${videoId}/comments`);
                const likesRef = db.ref(`video_interactions/${videoId}/likes`);
                const sharesRef = db.ref(`video_interactions/${videoId}/shares`);
                const presenceRef = db.ref(`video_interactions/${videoId}/presence`);
                const viewersCountSpan = document.getElementById('viewersCount');
                const likeBtn = document.getElementById('likeBtn');
                const likeCountSpan = document.getElementById('likeCount');
                const commentBtn = document.getElementById('commentBtn');
                const commentCountSpan = document.getElementById('commentCount');
                const shareBtn = document.getElementById('shareBtn');
                const shareCountSpan = document.getElementById('shareCount');
                const commentsWrapper = document.getElementById('comments-wrapper');
                const form = document.getElementById('commentForm');
                const commentsList = document.getElementById('commentsList');
                const isAdmin = window.location.search.includes('admin=true');
                db.ref('.info/connected').on('value', (s) => { if (s.val()) { const ref = presenceRef.push(); ref.onDisconnect().remove(); ref.set(true); }});
                presenceRef.on('value', (s) => { if(viewersCountSpan) viewersCountSpan.textContent = s.numChildren(); });
                if(commentBtn) commentBtn.addEventListener('click', () => { commentsWrapper.style.display = commentsWrapper.style.display === 'block' ? 'none' : 'block'; });
                commentsRef.on('value', (s) => { if(commentCountSpan) commentCountSpan.textContent = s.exists() ? s.numChildren() : 0; });
                if(likeBtn) likeBtn.addEventListener('click', () => { likesRef.transaction((c) => (c || 0) + 1); });
                likesRef.on('value', (s) => { if(likeCountSpan) likeCountSpan.textContent = s.val() || 0; });
                if(shareBtn) shareBtn.addEventListener('click', async () => { /* share logic */ });
                sharesRef.on('value', (s) => { if(shareCountSpan) shareCountSpan.textContent = s.val() || 0; });
                if(form) form.addEventListener('submit', (e) => { e.preventDefault(); const name = document.getElementById('name').value.trim(); const c = document.getElementById('comment').value.trim(); if (name && c) { commentsRef.push({ name, comment: c, timestamp: Date.now() }); form.reset(); } });
                commentsRef.on('child_added', (s) => { const data = s.val(), key = s.key; const el = document.createElement('div'); el.id = `comment-${key}`; el.style.marginBottom = '20px'; const time = new Date(data.timestamp).toLocaleString('id-ID'); el.innerHTML = `<div style="padding:10px;background:#fff;border:1px solid #ddd;border-radius:6px;text-align:left;"><strong>${data.name}</strong> <small style="color:gray;">(${time})</small><p style="margin:5px 0;">${data.comment}</p>${isAdmin ? `<button onclick="deleteComment('${key}')">Hapus</button>` : ""}</div>`; if(commentsList) commentsList.prepend(el); });
                window.deleteComment = (key) => { if (confirm("Yakin?")) { commentsRef.child(key).remove(); } };
                commentsRef.on('child_removed', (s) => { const el = document.getElementById(`comment-${s.key}`); if (el) el.remove(); });
            }
            const jadwalRef = db.ref('jadwalKajian'), pengumumanRef = db.ref('pengumuman'), tanggalRef = db.ref('infoSitus/rentangTanggal');
            const rentangTanggalKajianElem = document.getElementById('rentangTanggalKajian'), jadwalUstad1 = document.getElementById('jadwal-ustad1'), jadwalUstad2 = document.getElementById('jadwal-ustad2'), jadwalUstad3 = document.getElementById('jadwal-ustad3'), pengumumanContainer = document.getElementById('pengumuman-container');
            if(rentangTanggalKajianElem) tanggalRef.on('value', (s) => { rentangTanggalKajianElem.textContent = s.exists() ? s.val() : 'Jadwal Kajian Rutin'; });
            if(jadwalUstad1) jadwalRef.on('value', (s) => {
                jadwalUstad1.innerHTML = ''; jadwalUstad2.innerHTML = ''; jadwalUstad3.innerHTML = '';
                if(s.exists()){ s.forEach((cs) => { const j = cs.val(), item = `<li class="timeline-item"><div class="timeline-item-content"><span class="timeline-tag tag-dark">${j.jenis}</span><span class="timeline-tag tag-red">${j.waktu}</span><div><span class="timeline-tag tag-green">${j.lokasi}</span></div></div></li>`; if (j.ustadzId === 'ustad1') jadwalUstad1.innerHTML += item; else if (j.ustadzId === 'ustad2') jadwalUstad2.innerHTML += item; else if (j.ustadzId === 'ustad3') jadwalUstad3.innerHTML += item; });}
                else { jadwalUstad1.innerHTML = '<li style="color:white;">Belum ada jadwal.</li>'; }
            });
            if(pengumumanContainer) pengumumanRef.on('value', (s) => {
                pengumumanContainer.innerHTML = '<li>Memuat...</li>';
                if(s.exists()){ pengumumanContainer.innerHTML = ''; s.forEach((cs) => { const p = cs.val(); pengumumanContainer.innerHTML += `<li class="timeline-item"><div class="timeline-item-content"><div class="pengumuman-content"><img src="${p.flyerUrl}" class="pengumuman-flyer" alt="${p.judul}"><div class="pengumuman-details"><span class="timeline-tag tag-dark">${p.judul}</span><span class="timeline-tag tag-blue">Pemateri: ${p.pemateri}</span><div><span class="timeline-tag tag-green">${p.waktu}</span></div><div><span class="timeline-tag tag-red">${p.lokasi}</span></div></div></div></div></li>`; });}
                else { pengumumanContainer.innerHTML = '<li>Belum ada pengumuman.</li>';}
            });
            
            // --- LOGIKA VIDEO SCROLL DENGAN SEMUA PENYEMPURNAAN ---
            const reelsRef = db.ref('youtubeReels');
            const reelsFloatButton = document.getElementById('reels-float-button');
            const reelsViewer = document.getElementById('reelsViewer');
            const reelsContainer = document.getElementById('reelsContainer');
            const reelsCloseButton = document.getElementById('reelsCloseButton');
            let originalReels = [], isMutedByUser = true, scrollTimeout, intersectionObserver;

            function getYouTubeIDFromEmbed(embedCode) {
                if (!embedCode) return null;
                const srcMatch = embedCode.match(/src="[^"]*\/embed\/([^"?]+)/);
                return srcMatch ? srcMatch[1] : null;
            }
            
            reelsRef.on('value', (snapshot) => {
                if (snapshot.exists()) {
                    originalReels = Object.values(snapshot.val());
                    reelsFloatButton.style.display = originalReels.length > 0 ? 'flex' : 'none';
                } else {
                    originalReels = [];
                    reelsFloatButton.style.display = 'none';
                }
            });

            function buildReelsViewer() {
                reelsContainer.innerHTML = '';
                if (originalReels.length === 0) return;
                const reelsData = originalReels.length > 2
                    ? [originalReels[originalReels.length - 1], ...originalReels, originalReels[0]]
                    : [...originalReels, ...originalReels, ...originalReels];
                
                reelsData.forEach((reel, index) => {
                    const videoId = getYouTubeIDFromEmbed(reel.embedCode);
                    if (videoId) {
                        const slide = document.createElement('div');
                        slide.className = 'reel-slide';
                        slide.dataset.index = index;
                        slide.innerHTML = `
                            <div class="reel-video-wrapper">
                                <img src="https://i.ytimg.com/vi/${videoId}/hqdefault.jpg" class="reel-thumbnail" loading="lazy" alt="Thumbnail">
                                <div class="reel-iframe-container">
                                    <iframe data-src="https://www.youtube.com/embed/${videoId}?enablejsapi=1&rel=0&loop=1&playlist=${videoId}&origin=${window.location.origin}" allow="autoplay"></iframe>
                                </div>
                                <div class="reel-ui-overlay">
                                    <div class="reel-title">${reel.title || ''}</div>
                                    <div class="reel-channel">JBTV Official</div>
                                </div>
                                <button class="unmute-button"><i class="fa-solid fa-volume-xmark"></i></button>
                            </div>`;
                        reelsContainer.appendChild(slide);
                    }
                });

                setupIntersectionObserver();
                const firstRealSlideIndex = originalReels.length > 2 ? 1 : 0;
                const firstRealSlide = reelsContainer.querySelectorAll('.reel-slide')[firstRealSlideIndex];
                if (firstRealSlide) {
                    reelsContainer.scrollTo({ top: firstRealSlide.offsetTop, behavior: 'instant' });
                }
            }
            
            function activateIframe(slideElement) {
                const iframe = slideElement.querySelector('iframe');
                if (!iframe || iframe.src) return; 

                iframe.src = iframe.dataset.src;
                iframe.onload = () => {
                    const unmuteBtn = slideElement.querySelector('.unmute-button');
                    const thumbnail = slideElement.querySelector('.reel-thumbnail');
                    const player = iframe.contentWindow;
                    player.postMessage('{"event":"command","func":"playVideo","args":""}', '*');
                    
                    if (isMutedByUser) {
                        player.postMessage('{"event":"command","func":"mute","args":""}', '*');
                        unmuteBtn.classList.add('visible');
                    } else {
                        player.postMessage('{"event":"command","func":"unMute","args":""}', '*');
                        unmuteBtn.classList.remove('visible');
                    }
                    
                    setTimeout(() => { 
                        iframe.classList.add('loaded');
                        if(thumbnail) thumbnail.style.opacity = '0';
                    }, 500);
                };
            }

            function deactivateIframe(slideElement){
                const iframe = slideElement.querySelector('iframe');
                if (iframe && iframe.src) {
                    iframe.contentWindow.postMessage('{"event":"command","func":"mute","args":""}', '*');
                    iframe.contentWindow.postMessage('{"event":"command","func":"pauseVideo","args":""}', '*');
                }
            }

            function setupIntersectionObserver() {
                if(intersectionObserver) intersectionObserver.disconnect();
                intersectionObserver = new IntersectionObserver((entries) => {
                    entries.forEach(entry => {
                        const slide = entry.target;
                        if (entry.isIntersecting) {
                            document.querySelectorAll('.is-active-slide').forEach(active => active.classList.remove('is-active-slide'));
                            slide.classList.add('is-active-slide');
                            activateIframe(slide);
                        } else {
                            slide.classList.remove('is-active-slide');
                            deactivateIframe(slide);
                        }
                    });
                }, { root: reelsContainer, threshold: 0.7 });
                document.querySelectorAll('.reel-slide').forEach(slide => intersectionObserver.observe(slide));
            }
            
            reelsContainer.addEventListener('scroll', () => {
                clearTimeout(scrollTimeout);
                scrollTimeout = setTimeout(() => {
                    if (originalReels.length <= 2) return;
                    const slides = Array.from(reelsContainer.querySelectorAll('.reel-slide'));
                    const slideHeight = slides[0].offsetHeight;
                    if (slideHeight === 0) return;
                    
                    const lastRealSlideIndex = originalReels.length;
                    const lastRealSlide = slides[lastRealSlideIndex];
                    if (!lastRealSlide) return;

                    const lastRealSlideTop = lastRealSlide.offsetTop;
                    const firstCloneTop = slides[lastRealSlideIndex + 1]?.offsetTop;
                    const firstRealSlideTop = slides[1].offsetTop;
                    const currentScroll = reelsContainer.scrollTop;
                    
                    if (firstCloneTop && currentScroll >= firstCloneTop - 1) {
                        reelsContainer.scrollTo({ top: firstRealSlideTop, behavior: 'instant' });
                    }
                    if (currentScroll < firstRealSlideTop) {
                        reelsContainer.scrollTo({ top: lastRealSlideTop, behavior: 'instant' });
                    }
                }, 200);
            });

            reelsViewer.addEventListener('click', (e) => {
                if (e.target.closest('.unmute-button')) {
                    isMutedByUser = false;
                    reelsViewer.querySelectorAll('.unmute-button').forEach(btn => btn.classList.remove('visible'));
                    const activeSlide = reelsViewer.querySelector('.is-active-slide');
                    if (activeSlide) {
                        const activeIframe = activeSlide.querySelector('iframe');
                        if(activeIframe && activeIframe.src) {
                             activeIframe.contentWindow.postMessage('{"event":"command","func":"unMute","args":""}', '*');
                        }
                    }
                }
            });

            function openReelsViewer() {
                if (originalReels.length > 0) {
                    isMutedByUser = true;
                    buildReelsViewer();
                    reelsViewer.classList.add('active');
                    document.body.classList.add('reels-active');
                }
            }
            function closeReelsViewer() {
                reelsViewer.classList.remove('active');
                document.body.classList.remove('reels-active');
                reelsContainer.innerHTML = '';
            }
            reelsFloatButton.addEventListener('click', openReelsViewer);
            reelsCloseButton.addEventListener('click', closeReelsViewer);
        });
    </script>
</body>
</html>
